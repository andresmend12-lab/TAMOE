<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Detalle | Tamoe</title>
    <link rel="icon" href="imagotipo_tamoe.png" type="image/png"/>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#e619a1",
                        "background-light": "#f8f6f7",
                        "background-dark": "#21111c",
                        "surface-dark": "#2f1a28",
                        "surface-darker": "#1a0d15",
                        "text-muted": "#c893b6",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #21111c; }
        ::-webkit-scrollbar-thumb { background: #47243b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #e619a1; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-gray-900 dark:text-white font-display overflow-hidden flex flex-col h-screen">
    <header class="flex shrink-0 items-center justify-between border-b border-surface-dark px-6 py-3 bg-background-dark z-20">
        <div class="flex items-center gap-3 text-white">
            <img src="imagotipo_tamoe.png" class="h-8 w-auto" alt="Tamoe logo"/>
            <div class="flex flex-col">
                <span class="text-sm text-text-muted">Detalle</span>
                <h1 id="header-title" class="text-lg font-bold leading-tight tracking-tight">Cargando...</h1>
            </div>
        </div>
        <div class="flex items-center gap-2 text-text-muted text-sm">
            <span class="material-symbols-outlined">badge</span>
            <span id="header-manage" class="font-mono">...</span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 flex flex-col overflow-y-auto relative">
            <div class="px-8 py-8 flex flex-col gap-8 max-w-6xl mx-auto w-full">
                <!-- Breadcrumb -->
                <div id="breadcrumb" class="flex flex-wrap gap-2 items-center text-sm text-text-muted"></div>

                <!-- Title block -->
                <div class="flex flex-wrap justify-between items-start gap-4">
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center gap-2">
                            <span id="type-chip" class="bg-primary/15 text-primary text-xs font-bold px-2.5 py-1 rounded-md border border-primary/30 uppercase tracking-wide">...</span>
                            <span id="created-chip" class="text-text-muted text-xs bg-surface-dark px-2 py-1 rounded-md">...</span>
                        </div>
                        <h2 id="item-title" class="text-3xl md:text-4xl font-extrabold leading-tight tracking-tight text-white">Cargando...</h2>
                        <p id="item-manage" class="text-text-muted text-sm font-mono">...</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="open-dashboard" class="flex items-center gap-2 h-10 px-4 rounded-lg border border-surface-dark text-text-muted hover:text-white hover:bg-surface-dark transition-colors text-sm font-bold">
                            <span class="material-symbols-outlined text-[18px]">dashboard</span>
                            Volver al dashboard
                        </button>
                    </div>
                </div>

                <!-- Info grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 flex flex-col gap-6">
                        <section class="bg-surface-darker border border-border-dark rounded-xl p-5 shadow-xl">
                            <h3 class="text-white text-lg font-bold flex items-center gap-2 mb-3">
                                <span class="material-symbols-outlined text-primary">info</span>
                                Resumen
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-text-muted">
                                <div class="flex flex-col gap-1">
                                    <span class="uppercase text-xs font-bold tracking-wide text-text-muted/80">Nombre</span>
                                    <span id="field-name" class="text-white text-base font-semibold">-</span>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <span class="uppercase text-xs font-bold tracking-wide text-text-muted/80">Tipo</span>
                                    <span id="field-type" class="text-white">-</span>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <span class="uppercase text-xs font-bold tracking-wide text-text-muted/80">Manage ID</span>
                                    <span id="field-manage" class="text-white font-mono">-</span>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <span class="uppercase text-xs font-bold tracking-wide text-text-muted/80">Creado</span>
                                    <span id="field-created" class="text-white">-</span>
                                </div>
                            </div>
                        </section>

                        <section class="bg-surface-darker border border-border-dark rounded-xl p-5 shadow-xl">
                            <h3 class="text-white text-lg font-bold flex items-center gap-2 mb-3">
                                <span class="material-symbols-outlined text-primary">article</span>
                                Descripción
                            </h3>
                            <p id="field-description" class="text-gray-300 text-sm leading-relaxed">Aún no hay descripción para este elemento.</p>
                        </section>
                    </div>

                    <div class="flex flex-col gap-6">
                        <section class="bg-surface-darker border border-border-dark rounded-xl p-5 shadow-xl">
                            <h3 class="text-white font-bold flex items-center gap-2 mb-3">
                                <span class="material-symbols-outlined text-primary">badge</span>
                                Metadatos
                            </h3>
                            <div class="flex flex-col gap-3 text-sm text-text-muted">
                                <div class="flex items-center justify-between">
                                    <span>Cliente</span>
                                    <span id="meta-client" class="text-white font-semibold truncate max-w-[10rem] text-right">-</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Proyecto</span>
                                    <span id="meta-project" class="text-white font-semibold truncate max-w-[10rem] text-right">-</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Producto</span>
                                    <span id="meta-product" class="text-white font-semibold truncate max-w-[10rem] text-right">-</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Tarea</span>
                                    <span id="meta-task" class="text-white font-semibold truncate max-w-[10rem] text-right">-</span>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <div id="error-box" class="hidden rounded-lg border border-red-400 bg-red-500/10 text-red-100 px-4 py-3 text-sm"></div>
            </div>
        </main>
    </div>

    <script type="module">
        import { database } from './firebase.js';
        import { ref, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const getManageIdFromUrl = () => {
            const params = new URLSearchParams(window.location.search);
            const mid = params.get('mid');
            if (mid) return mid.toUpperCase();
            const parts = window.location.pathname.split('/').filter(Boolean);
            const last = parts[parts.length - 1];
            if (last && /[A-Za-z0-9]{2}-\d{3,}/.test(last)) return last.toUpperCase();
            return null;
        };

        const manageId = getManageIdFromUrl();
        if (manageId && window.location.pathname.indexOf(manageId) === -1) {
            window.history.replaceState({}, '', `/${manageId}`);
        }

        const qs = (id) => document.getElementById(id);
        const setText = (id, value) => { const el = qs(id); if (el) el.textContent = value || '-'; };
        const showError = (msg) => { const box = qs('error-box'); if (!box) return; box.classList.remove('hidden'); box.textContent = msg; };

        const TYPE_LABELS = {
            client: 'Cliente',
            project: 'Proyecto',
            product: 'Producto',
            task: 'Tarea',
            subtask: 'Subtarea'
        };

        const findByManageId = (clients, mid) => {
            for (const client of clients) {
                if (client.manageId === mid) return { type: 'client', item: client, trail: [client] };

                const projects = client.projects || {};
                for (const [pid, project] of Object.entries(projects)) {
                    if (project.manageId === mid) return { type: 'project', item: project, trail: [client, project] };

                    const tasks = project.tasks || {};
                    for (const [tid, task] of Object.entries(tasks)) {
                        if (task.manageId === mid) return { type: 'task', item: task, trail: [client, project, task] };
                        const subtasks = task.subtasks || {};
                        for (const sub of Object.values(subtasks)) {
                            if (sub.manageId === mid) return { type: 'subtask', item: sub, trail: [client, project, task, sub] };
                        }
                    }

                    const products = project.products || {};
                    for (const product of Object.values(products)) {
                        if (product.manageId === mid) return { type: 'product', item: product, trail: [client, project, product] };
                        const prodTasks = product.tasks || {};
                        for (const [tid, task] of Object.entries(prodTasks)) {
                            if (task.manageId === mid) return { type: 'task', item: task, trail: [client, project, product, task] };
                            const subtasks = task.subtasks || {};
                            for (const sub of Object.values(subtasks)) {
                                if (sub.manageId === mid) return { type: 'subtask', item: sub, trail: [client, project, product, task, sub] };
                            }
                        }
                    }
                }
            }
            return null;
        };

        const formatDate = (iso) => {
            if (!iso) return '-';
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return '-';
            return d.toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' });
        };

        const breadcrumb = qs('breadcrumb');
        const renderBreadcrumb = (trail, type) => {
            if (!breadcrumb) return;
            breadcrumb.innerHTML = '';
            trail.forEach((node, idx) => {
                const span = document.createElement('span');
                span.className = 'text-text-muted';
                span.textContent = node.name || TYPE_LABELS[type] || 'Detalle';
                breadcrumb.appendChild(span);
                if (idx < trail.length - 1) {
                    const icon = document.createElement('span');
                    icon.className = 'material-symbols-outlined text-text-muted text-[16px]';
                    icon.textContent = 'chevron_right';
                    breadcrumb.appendChild(icon);
                }
            });
        };

        const populateView = (result) => {
            const { type, item, trail } = result;
            const title = item.name || TYPE_LABELS[type] || 'Detalle';
            qs('header-title').textContent = title;
            qs('header-manage').textContent = item.manageId || manageId || '—';
            qs('item-title').textContent = title;
            qs('item-manage').textContent = item.manageId || manageId || '—';
            qs('type-chip').textContent = TYPE_LABELS[type] || 'Detalle';
            qs('field-name').textContent = title;
            qs('field-type').textContent = TYPE_LABELS[type] || '-';
            qs('field-manage').textContent = item.manageId || manageId || '-';
            qs('field-created').textContent = formatDate(item.createdAt);
            qs('created-chip').textContent = formatDate(item.createdAt);
            renderBreadcrumb(trail, type);

            const metaMap = {
                client: '-',
                project: '-',
                product: '-',
                task: '-'
            };

            if (type === 'client') {
                metaMap.client = item.name || '-';
            } else if (type === 'project') {
                metaMap.client = trail[0]?.name || '-';
                metaMap.project = item.name || '-';
            } else if (type === 'product') {
                metaMap.client = trail[0]?.name || '-';
                metaMap.project = trail[1]?.name || '-';
                metaMap.product = item.name || '-';
            } else if (type === 'task') {
                metaMap.client = trail[0]?.name || '-';
                metaMap.project = trail[1]?.name || '-';
                metaMap.product = trail[2]?.manageId === item.manageId ? '-' : trail[2]?.name || '-';
                metaMap.task = item.name || '-';
            } else if (type === 'subtask') {
                metaMap.client = trail[0]?.name || '-';
                metaMap.project = trail[1]?.name || '-';
                metaMap.product = trail.find(n => n.manageId && n.manageId.startsWith(metaMap.client?.slice(0,2)))?.name || '-';
                metaMap.task = trail[trail.length - 2]?.name || '-';
            }

            setText('meta-client', metaMap.client);
            setText('meta-project', metaMap.project || '-');
            setText('meta-product', metaMap.product || '-');
            setText('meta-task', metaMap.task || '-');

            qs('field-description').textContent = item.description || 'Aún no hay descripción para este elemento.';
        };

        const loadData = async () => {
            if (!manageId) {
                showError('No se encontró un manageId válido en la URL.');
                return;
            }
            try {
                const snap = await get(ref(database, 'clients'));
                const data = snap.val() || {};
                const clients = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                const found = findByManageId(clients, manageId);
                if (!found) {
                    showError(`No se encontró información para ${manageId}.`);
                    return;
                }
                populateView(found);
            } catch (err) {
                console.error(err);
                showError(err.message || 'Error cargando datos.');
            }
        };

        qs('open-dashboard')?.addEventListener('click', () => {
            window.location.href = 'maindashboard.html';
        });

        loadData();
    </script>
</body>
</html>
